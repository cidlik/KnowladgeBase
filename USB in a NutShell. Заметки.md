#hardware #usb #nutshell

### Ресурсы

1. [USB in a NutShell - путеводитель по стандарту USB (перевод)](http://microsin.ru/content/view/1107/44/)
2. [Положительное выравнивание](https://ru.wikipedia.org/wiki/%D0%9F%D0%BE%D0%BB%D0%BE%D0%B6%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D0%B5_%D0%B2%D1%8B%D1%80%D0%B0%D0%B2%D0%BD%D0%B8%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5)
3. [USB 101: An Introduction to Universal Serial Bus 2.0](https://www.infineon.com/dgdl/Infineon-AN57294_USB_101_An_Introduction_to_Universal_Serial_Bus_2.0-ApplicationNotes-v09_00-EN.pdf?fileId=8ac78c8c7cdc391c017d072d8e8e5256)
4. [Detecting a High-Speed USB Device](https://microchipdeveloper.com/usb:high-speed-detect)
5. [USB Protocol: Types of USB Packets and USB Transfers (Part 2/6)](https://www.engineersgarage.com/usb-protocol-types-of-usb-packets-and-usb-transfers-part-2-6/)
6. [Макет USB-устройства](https://learn.microsoft.com/ru-ru/windows-hardware/drivers/usbcon/usb-device-layout)

**Note 1** Статья старая, по её меркам USB2.0 - что-то супер современное и
невероятное. По идее, мне для знакомства должно хватить, т.к. 2.0 до сих пор в
ходу. По мере прочтения постараюсь добавлять и более актуальную информацию.

**Note 2** Кажется, придется про USB 3.0 писать отдельно.

### Глава 1. Введение

Скорости в USB:

* Low Speed - 1.5 Mbits/s
* Full Speed - 12 Mbits/s
* High Speed - 480 Mbits/s (появилось в 2.0)

**Universal Serial Bus (USB)** - шина, управляемая хостом. В самом простом
случае есть хост, который управляет устройствами. Стандарты до 2.0 так и
предполагались. В ревизии 2.0 появилось приложение, описывающее режим
**On-The-Go (OTG)**, когда два хоста могут договориться, кто кем будет
управлять (см. Host Negotiation Protocol).

USB использует топологию **многоярусная звезда (tiered star)**. Это
предполагает, что к одному хабу могут быть подключены еще хабы и т.д. Если мне
не изменяет память, USB поддерживает до 5 "ярусов звезды".

Указывается, что к одной шине может быть подключено до 127 устройств.

Контроллеры хоста USB описываются интерфейсами (Host Controller Interface):

* UHCI/OHCI (1.1) (Universal/Open);
* EHCI (2.0) (Enchanced);
* XHCI (3.0) (eXtensible).

**USB** - последовательная шина, ВНЕЗАПНО. Минимально используется 4
экранированных провода (в смысле, 4 провода в стяжке, стяжка обвита экраном -
фольга или оплетка). Провод питания (+5В), земля + витая пара дли передачи
дифференциальных сигналов данных. Используется схема кодирования **NRZI**.
Данное кодирование является самосинхронизирующимся, как тот же 8B/10B, например.

USB поддерживает «горячее» (plug’n’play) соединение с динамически загружаемыми
и выгружаемыми драйверами. Согласно статье, выбор драйвера осуществляется путем
чтения комбинации PID:VID.

Указывается, что USB поддерживает режимы передачи (transfer):

* Control;
* Interrupt;
* Bulk;
* Isochronous.

### Глава 2. Железо.

#### Коннекторы

<img src="img\usb\usb_connectors.jpg" alt="usb_connectors">

Вводятся такие понятия, как *upstream* порт и *downstream*.
**Upstream** порты - для использования устройства в качестве устройства.
**Downstream** порты - для использования устройства в качестве хоста.

*Note* Т.к. главный - хост, то все, что он сливает, идет "вниз", потому и
downstream.

Вводятся термины **plug** (разъем "папа") и **socket** (разъем "мама").

| Номер контакта | Цвет провода | Функция |
|----------------|--------------|---------|
|       1        |  Красный     | VBUS*   |
|       2        |  Белый       | D-      |
|       3        |  Зеленый     | D+      |
|       4        |  Черный      | GND     |

*VBUS = 5 В

#### Электрическая спецификация

Как было сказано выше, используется тип кодирования **NRZI**.

<img src="img\usb\nrzi_coding.png" alt="nrzi_coding">

В USB используется вариант 2, когда при появлении 0 уровни меняются на
противоположные, при 1 - не меняется.

Также используется "bit stuffing" [2] - "положительное выравнивание". Это
требуется для случаев, когда долго не происходит смена уровней, т.к.
приёмопередатчики могут утерять синхронизацию. USB гарантирует, что после шести
последовательных единичных символов вставится ноль, который обеспечит
возможность синхронизации.

Высоким уровнем считается > 2.8 В.
Низким уровнем считается < 0.3 В.

Согласно [3], вводятся понятия:

| Bus State             | Indication                                            |
|-----------------------|-------------------------------------------------------|
| Differential 1        | D+ High, D- Low                                       |
| Differential 0        | D+ Low, D- High                                       |
| Single Ended 0 (SE0)  | D+ and D- Low                                         |
| Single Ended 1 (SE1)  | D+ and D- High                                        |
| J-State: <br/> * Low-Speed <br/> * Full-Speed <br/> * High-Speed | <br/> Differential 0 <br/> Differential 1 <br/> Differential 1 |
| K-State: <br/> * Low-Speed <br/> * Full-Speed <br/> * High-Speed | <br/> Differential 1 <br/> Differential 0 <br/> Differential 0 |
| Idle: <br/> * Low-Speed <br/> * Full-Speed | <br/> Differential 0 <br/> Differential 1 |
| Resume State          | K-State                                               |
| Start of Packet (SOP) | Data lines switch from idle to K-State.               |
| End of Packet (EOP)   | SE0 for 2 bit time followed by J-State for 1 bit time |

Шины в режиме Low- и Full-Speed имеют волновое **дифференциальное**
сопротивление 90 Ом или же несимметричное сопротивление - 45 Ом.

    Несимметричный импеданс — это импеданс дорожки относительно земли.
    Дифференциальный импеданс — это импеданс между двумя сигнальными дорожками
    дифференциальной пары.

Режим High Speed (480Mbits/s) использует постоянный ток 17.78 mA для передачи
сигналов – с целью уменьшения шума.

У хоста линии `D+` и `D-` подтягиваются к земле через 15 кОм резисторы.

#### Идентификация скорости

Устройство USB показывает, в каком режиме оно готово работать (Low или Full)
путем подтягивания линии данных к 3.3 В:

* если Low, то к 3.3 В подтягивается `D-`;
* если Full, то к 3.3 В подтягивается `D+`.

Без pull-up резистора считается, что к шине USB ничего не подключено. Этот
резистор может быть встроенным в м/сх.

С High-Speed все сложнее [4]. Сначала устройство определяется в режиме
Full-Speed, далее выполняется сброс и попытка перехода на High-Speed.

<img src="img\usb\usb_hs_detection.png" alt="usb_hs_detection">

Во время сброса устройство High-Speed отправляет сигнал `device chirp` с силой
тока 17.8 мА по линии D-. Хост, если он поддерживает High-Speed, обнаруживает
0.8 В на D- (0.0178 А* 45 Ом = 0.8 В). Если в течение 100 мкс хаб обнаруживает
`device chirp`, то он отвечает последовательностью чередующихся K-J чирпов по
50 мкс каждый. Если устройство обнаруживает 3 последовательных чирпа, то оно
подключает оконечную нагрузку к D+ и D-.

Устройства с USB >= 2.0, видимо, не должны поддерживать 1-ю ревизию USB. Видимо,
связано с различиями в полярностях сигналов и процедурой определения версии.

#### Питание (VBUS)

Одна из особенностей USB - есть возможность запитывать устройства прямо от шины
(bus-powered devices). Устройство указывает свое энергопотребление в дескрипторе
(видимо, MaxPower). *Пример*: `MaxPower = 0xFA`, т.е. максимальное потребление
будет равно 500 мА (`0xFA * 2 мА = 250 * 2мА`).

В [1] говорится 3-х классах функций:

* Low-power (от шины);
* High-power (от шины);
* Self-powered (от собственного источника).

**Low-power** - данные устройства могут потреблять не более одного юнита
нагрузки (1 unit load = 100 мА).

**High-power** - пока не сконфигурированы хостом могут потреблять не более 1
юнита нагрузки, после конфигурации - до 5 юнитов (500 мА - максимальная
нагрузка).

**Self-powered** могут потреблять не более 1 юнита, остальная требуемая мощность
берется от своего источника питания. Этот 1 юнит используется для операций
детектирования и перечисления (enumeration). Об последнем возможно позже будет.

**Питание подает хост!!!**

Важно помнить, что при подключении устройства возникнет паразитная емкость
между VBUS и GND, которая может привести к скачку тока. В каких-то схемах люди
ставят индуктивности по VBUS, которые будут, соответственно, гасить всплески
тока. Также важно, что при отсоединении устройства возникает ЭДС самоиндукции
за счет индуктивности кабеля. Для этого вроде как ставят развязывающую емкость
на VBUS или м/сх ESD.

#### Suspend mode

**TBU**

### Глава 3. Протоколы USB.

Автор статьи говорит, что "USB состоит из нескольких слоев протоколов...
Большинство контроллеров берет на себя заботу о нижних слоях."

#### Общие поля пакета USB

Согласно [5], в пакете могут содержаться следующие поля:

* **Sync** - обязательное поле, с которого начинается каждый пакет. Оно
  позволяет синхронизировать передатчик с приёмником. Для Low- и Full-Speed
  режимов длина поля 8 бит (KJ-пара х3 + 2K x2), для High-Speed - 32 бита
  (KJ-пара х15 + 2K x2).
* **PID** - какой тип пакета будет отправлен. Длина - 8 бит. Старшие 4 бита
  отвечают за тип, младшие - побитовое дополнение для старших (помогают ошибки
  определить).

  **Заметка для таких дурачков, как я** PID - это не Product ID, обалдуй. Это
  Packet ID.

  <img src="img\usb\usb_pid_table.jpg" alt="usb_pid_table">

  **Note** Судя по всему, побитовое дополнение (bitwise compliment) - это
  инвертированные старшие биты. Ex:

    ```
    OUT: 0001 1110
         ^    ^
         |    |
    старшие   младшие
    ```
* **ADDR** - содержит адрес назначения устройства. Длина - 7 бит, т.е. можно
  адресовать 127 устройств. Адрес 0 не допустим. Он используется для устройств,
  которым адрес не назначен.
* **ENDP** - номер оконечной точки (endpoint). Длина - 4 бита -> 16 endpoint'ов.
* **CRC** - поле циклического избыточного кода. Для token пакета - 5 бит, для
  данных - 16 бит.
* **EOP** - поле конца пакета. Состоит из SE0 x2 + J бит.

#### Типы пакетов

Каждая транзакция состоит из [5]:

* Token Packet - заголовок, указывающий, что должно передаваться далее. Данный
  тип пакетов отправляется только хостом. Выглядит следующим образом:

  ```
  +------+-----+----------------+-----------+-----------+-----+
  | Sync | PID | Device Address | End Point | CRC 5-Bit | EOP |
  +------+-----+----------------+-----------+-----------+-----+
  ```

  Типы token packet:

    * **In** - пакет сообщает устройству, что хост хочет прочитать информацию;
    * **Out** - пакет сообщает устройству, что хост хочет записать информацию;
    * **Setup** - данный пакет используется для начала управляющей передачи
      (control transfer);
    * **Ping** - перед тем, как отправлять пару Out/Data, этот токен опрашивает
      устройство, готово ли оно принимать Out/Data;
    * **Split** - используется для связи между Low-/Full-Speed устройствами на
      High-Speed шине.

* Data Packet:

  ```
  +------+-----+------+------------+-----+
  | Sync | PID | Data | CRC 16-Bit | EOP |
  +------+-----+------+------------+-----+
  ```

    * Для Low-Speed: максимальная длина Data = 8 байт;
    * Для Full-Speed: максимальная длина Data = 1023 байт;
    * Для High-Speed: максимальная длина Data = 1024 байт;

  В Low- и Full-Speed режимах в PID пишется идентификатор `Data 0` или `Data 1`.
  Как указывается в [3], это еще один способ определения ошибок. При каждой
  успешной передаче пакета происходит переключение с `Data 0` на `Data 1` и
  обратно. В качестве примера указывается ситуация, когда ACK был отправлен, но
  не получен. Тогда на приёмнике и на передатчике будут разные `Data x`, что
  приведет к ошибке.

  В режиме High Speed задаются два других data PID - DATA2 и MDATA.

* Handshake Packet - зачастую это ответ на пакет данных.

  ```
  +------+-----+-----+
  | Sync | PID | EOP |
  +------+-----+-----+
  ```

  В поле PID может быть:

    * **ACK** - подтверждение, что пакет успешно принят;
    * **NAK** - пакет временно не может быть принят/отправлен. Также показывает,
      что нет данных для отправки (исп-ся в interrupt транзакциях);
    * **STALL** - устройство в состоянии ошибки, требуется вмешательство хоста;
    * **NYET** - split-транзакция еще не была завершена;
    * **ERR** - split-транзакция завершилась ошибкой.

* Start of Frame Packet - пакет нужен для отсылки номера фрейма. Отправляется
  каждые 1 ms $\pm$ 500 ns на Full-Speed или 125 µs $\pm$ 0.0625 µs на high
  speed.

  ```
  +------+------------+--------------+------+-----+
  | Sync | PID (0101) | Frame Number | CRC5 | EOP |
  +------+------------+--------------+------+-----+
  ```

#### Конфигурация USB

**Конфигурация USB** определяет возможности устройства и его функции. Устройство
может иметь несколько конфигураций, но единовременно может быть активна только
одна. Активную конфигурацию выбирает драйвер устройства.

Конфигурация устройства может иметь один или несколько **USB-интерфейсов**,
определяющий функции. Обычно один интерфейс - одна функция.

#### Оконечные точки (endpoints)

<img src="img\usb\usb_host_endpoints.png" alt="usb_host_endpoints">

Конечная точка - это буфер на USB-устройстве. Термин относится непосредственно
к оборудованию.

Т.к. USB является хосториентированной шиной, то endpoint'ы оказываются в конце
канала связи. Если хост хочет отправить данные устройству, то он отправляет
пакет с OUT в конечную точку EP (EP1 e.g.). Теперь устройство может неспеша
прочитать данные из буфера EP1 Out.

Если же устройство захочет вернуть какие-то данные хосту, то самостоятельно оно
это сделать не сможет (хосториентированность, помнишь, да? Я помню...).
Устройство выставляет данные в буфер EP1 In, они там лежат, пока хост их не
запросит пакетом с In.

Все устройства должны поддерживать конечную точку 0. Это конечная точка, которая
принимает все управляющие запросы (Setup?) и запросы статуса во время энумерации
и в течение всего времени, когда устройство остается работоспособным на шине.
Данная конечная точка является двунаправленной и позволяет хосту получить
информацию об устройстве. Остальные конечные точки являются однонаправленными,
имеют тип

#### Потоки/каналы/пайпы (pipes)
